{# Task item partial - reusable component for task display #}
{# Expects: task (Task entity) #}

<div data-task-item
     data-task-id="{{ task.id }}"
     class="bg-white shadow rounded-lg p-4 hover:shadow-md transition-shadow duration-200 {% if overdueInfo is defined and overdueInfo.isOverdue %}{{ overdueInfo.borderClass }}{% elseif task.isOverdue %}border-l-4 border-l-red-500{% endif %}"
     x-data="taskItem('{{ task.id }}', '{{ task.status }}')"
     @closeAll.window="showDeleteModal = false"
     @toggle-subtasks.window="if ($event.detail.taskId === '{{ task.id }}') { $store.subtasks?.toggle('{{ task.id }}') }"
     tabindex="-1">
    <div class="flex items-start justify-between">
        <div class="flex-1 min-w-0">
            {# Task title and status #}
            <div class="flex items-center gap-3">
                {# Issue #59: AJAX status toggle - no page refresh #}
                <button type="button"
                        @click="toggleStatus()"
                        :disabled="isUpdating"
                        class="flex-shrink-0 min-h-11 min-w-11 sm:min-h-0 sm:min-w-0 h-6 w-6 sm:h-5 sm:w-5 rounded-full transition-colors flex items-center justify-center"
                        :class="status === 'completed'
                            ? 'bg-green-500 hover:bg-green-600'
                            : status === 'in_progress'
                                ? 'border-2 border-blue-500 bg-blue-50 hover:border-green-500 hover:bg-green-50'
                                : 'border-2 border-gray-300 hover:border-green-500 hover:bg-green-50'"
                        :title="status === 'completed' ? 'Mark as pending' : 'Mark as completed'">
                    <svg x-show="status === 'completed'" class="w-4 h-4 sm:w-3 sm:h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </button>

                {# Title - reactive strikethrough based on status #}
                <h3 class="text-sm font-medium truncate"
                    :class="status === 'completed' ? 'line-through text-gray-500' : 'text-gray-900'">
                    {{ task.title }}
                </h3>
            </div>

            {# Task meta info #}
            <div class="mt-2 flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-2 ml-9">
                {# Status badge - reactive based on status #}
                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium"
                      :class="{
                          'bg-yellow-100 text-yellow-800': status === 'pending',
                          'bg-blue-100 text-blue-800': status === 'in_progress',
                          'bg-green-100 text-green-800': status === 'completed'
                      }"
                      x-text="status === 'pending' ? 'Pending' : status === 'in_progress' ? 'In Progress' : 'Completed'">
                </span>

                {# Issue #34: Priority badge with semantic colors #}
                {% if task.priority == 1 %}
                    <span class="inline-flex items-center rounded-full bg-red-100 px-2 py-0.5 text-xs font-medium text-red-800" title="Urgent">
                        P1
                    </span>
                {% elseif task.priority == 2 %}
                    <span class="inline-flex items-center rounded-full bg-orange-100 px-2 py-0.5 text-xs font-medium text-orange-800" title="High">
                        P2
                    </span>
                {% elseif task.priority == 3 %}
                    <span class="inline-flex items-center rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800" title="Medium">
                        P3
                    </span>
                {% elseif task.priority == 4 %}
                    <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-800" title="Low">
                        P4
                    </span>
                {% else %}
                    <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600" title="Lowest">
                        P5
                    </span>
                {% endif %}

                {# Due date #}
                {% if task.dueDate %}
                    {% set isOverdue = task.isOverdue %}
                    <span class="inline-flex items-center gap-1 text-xs {% if isOverdue %}text-red-600{% else %}text-gray-500{% endif %}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        {{ task.dueDate|date('M j, Y') }}
                        {% if isOverdue %}
                            <span class="font-medium">(Overdue)</span>
                        {% endif %}
                    </span>
                {% endif %}

                {# Project badge #}
                {% if task.project %}
                    <span class="inline-flex items-center gap-1 text-xs text-indigo-600 bg-indigo-50 rounded-full px-2 py-0.5">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        {{ task.project.name }}
                    </span>
                {% endif %}

                {# Recurring indicator #}
                {% if task.isRecurring %}
                    <span class="inline-flex items-center gap-1 text-xs text-gray-500" title="{{ task.recurrenceRule ?: 'Recurring task' }}">
                        {# Arrow-path icon (Heroicons) #}
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="sr-only">Recurring: {{ task.recurrenceRule }}</span>
                    </span>
                {% endif %}

                {# Issue #44: Subtask button - always visible for discoverability #}
                {% set subtasks = task.subtasks %}
                {% set subtaskCount = subtasks|length %}
                {% if subtaskCount > 0 %}
                    {% set completedSubtasks = subtasks|filter(s => s.status == 'completed')|length %}
                    {% set progressPercent = ((completedSubtasks / subtaskCount) * 100)|round %}
                    <button type="button"
                            @click="$dispatch('toggle-subtasks', { taskId: '{{ task.id }}' })"
                            class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-700 hover:bg-gray-200 transition-colors"
                            title="{{ completedSubtasks }}/{{ subtaskCount }} subtasks completed">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        {{ completedSubtasks }}/{{ subtaskCount }}
                        {# Progress bar #}
                        <span class="inline-block w-12 h-1.5 bg-gray-200 rounded-full overflow-hidden ml-1">
                            <span class="block h-full bg-green-500 rounded-full transition-all duration-300" style="width: {{ progressPercent }}%"></span>
                        </span>
                        {# Chevron icon #}
                        <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': subtasksExpanded?.['{{ task.id }}'] }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                {% else %}
                    {# Issue #44: Add subtask button shown when no subtasks exist #}
                    <button type="button"
                            @click="$dispatch('toggle-subtasks', { taskId: '{{ task.id }}' })"
                            class="inline-flex items-center gap-1 rounded-full bg-gray-50 px-2 py-0.5 text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-colors"
                            title="Add subtask">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Subtask
                    </button>
                {% endif %}
            </div>

            {# Description preview #}
            {% if task.description %}
                <p class="mt-2 text-sm text-gray-500 line-clamp-2 ml-9">{{ task.description }}</p>
            {% endif %}

            {# Issue #44: Expandable subtask list - always available #}
            <div x-show="subtasksExpanded?.['{{ task.id }}']"
                 x-cloak
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 -translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 translate-y-0"
                 x-transition:leave-end="opacity-0 -translate-y-2"
                 class="mt-3 ml-9 space-y-2"
                 data-subtasks-container="{{ task.id }}">

                {% if subtaskCount > 0 %}
                {# Subtask list - Issue #59: AJAX status toggle #}
                <div class="space-y-1.5 border-l-2 border-gray-200 pl-3">
                    {% for subtask in subtasks %}
                        <div class="flex items-center gap-2 py-1"
                             data-subtask-id="{{ subtask.id }}"
                             x-data="{ status: '{{ subtask.status }}', updating: false }">
                            <button type="button"
                                    @click="
                                        if (updating) return;
                                        updating = true;
                                        const newStatus = status === 'completed' ? 'pending' : 'completed';
                                        window.api.patch('/api/v1/tasks/{{ subtask.id }}', { status: newStatus })
                                            .then(r => r.json())
                                            .then(data => { if (data.success) status = newStatus; })
                                            .finally(() => updating = false);
                                    "
                                    :disabled="updating"
                                    class="flex-shrink-0 h-4 w-4 rounded border flex items-center justify-center transition-colors"
                                    :class="status === 'completed' ? 'bg-green-500 border-green-500' : 'border-gray-300 hover:border-green-400'"
                                    :title="status === 'completed' ? 'Mark as pending' : 'Mark as completed'">
                                <svg x-show="status === 'completed'" class="w-2.5 h-2.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                            <span class="text-sm"
                                  :class="status === 'completed' ? 'text-gray-400 line-through' : 'text-gray-700'">
                                {{ subtask.title }}
                            </span>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}

                {# Inline subtask creation form - uses window.api for session auth #}
                <form class="flex items-center gap-2 {% if subtaskCount > 0 %}pl-3{% endif %}"
                      x-data="{ title: '', submitting: false }"
                      @submit.prevent="
                          if (!title.trim() || submitting) return;
                          submitting = true;
                          window.api.post('/api/v1/tasks/{{ task.id }}/subtasks', { title: title })
                              .then(r => r.json())
                              .then(data => {
                                  if (data.success) {
                                      window.location.reload();
                                  }
                              })
                              .finally(() => submitting = false);
                      ">
                    <div class="flex-shrink-0 h-4 w-4 rounded border border-dashed border-gray-300"></div>
                    <input type="text"
                           x-model="title"
                           placeholder="Add subtask..."
                           class="flex-1 text-sm border-0 border-b border-transparent focus:border-indigo-500 focus:ring-0 py-1 px-0 placeholder-gray-400"
                           :disabled="submitting">
                    <button type="submit"
                            class="text-xs text-indigo-600 hover:text-indigo-800 font-medium disabled:opacity-50"
                            :disabled="!title.trim() || submitting">
                        Add
                    </button>
                </form>
            </div>
        </div>

        {# Actions dropdown #}
        <div class="flex-shrink-0 ml-4" x-data="{ open: false }" @closeAll.window="open = false">
            <div class="relative">
                <button @click="open = !open" type="button" class="min-h-11 min-w-11 sm:min-h-0 sm:min-w-0 inline-flex items-center justify-center rounded-md bg-white px-2 py-1 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <span class="sr-only">Open task menu</span>
                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                    </svg>
                </button>

                <div x-show="open"
                     x-cloak
                     @click.away="open = false"
                     x-transition:enter="transition ease-out duration-100"
                     x-transition:enter-start="transform opacity-0 scale-95"
                     x-transition:enter-end="transform opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-75"
                     x-transition:leave-start="transform opacity-100 scale-100"
                     x-transition:leave-end="transform opacity-0 scale-95"
                     class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">

                    {# Issue #59: AJAX status change options #}
                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b">
                        Change Status
                    </div>
                    <button x-show="status !== 'pending'"
                            @click="open = false; setStatus('pending')"
                            type="button"
                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <span class="inline-flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                            Mark as Pending
                        </span>
                    </button>
                    <button x-show="status !== 'in_progress'"
                            @click="open = false; setStatus('in_progress')"
                            type="button"
                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <span class="inline-flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                            Mark as In Progress
                        </span>
                    </button>
                    <button x-show="status !== 'completed'"
                            @click="open = false; setStatus('completed')"
                            type="button"
                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <span class="inline-flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-400"></span>
                            Mark as Completed
                        </span>
                    </button>

                    <div class="border-t my-1"></div>

                    {# Issue #35: Edit Task button #}
                    <button @click="open = false; $dispatch('open-edit-modal', { taskId: '{{ task.id }}' })"
                            type="button"
                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <span class="inline-flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            Edit Task
                        </span>
                    </button>

                    <div class="border-t my-1"></div>

                    {# Delete button #}
                    <button @click="open = false; showDeleteModal = true" type="button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                        Delete Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Delete confirmation modal #}
    <div x-show="showDeleteModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         aria-labelledby="modal-title"
         role="dialog"
         aria-modal="true">
        <div class="flex min-h-screen items-end justify-center px-4 pb-20 pt-4 text-center sm:block sm:p-0">
            {# Background overlay #}
            <div x-show="showDeleteModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click="showDeleteModal = false"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

            <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>

            {# Modal panel #}
            <div x-show="showDeleteModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="relative inline-block transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6 sm:align-middle">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                        <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Delete Task</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Are you sure you want to delete "{{ task.title }}"? This action cannot be undone.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <form action="{{ path('app_task_delete', {id: task.id}) }}" method="POST" class="inline">
                        <input type="hidden" name="_csrf_token" value="{{ csrf_token('delete_task_' ~ task.id) }}">
                        <button type="submit" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto">Delete</button>
                    </form>
                    <button @click="showDeleteModal = false" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
