{# Issue #35: Task Edit Modal Component #}
{# Global modal for editing tasks - listens for open-edit-modal events #}

<div x-data="taskEditModal()"
     @open-edit-modal.window="openModal($event.detail.taskId)"
     x-show="isOpen"
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     aria-labelledby="edit-modal-title"
     role="dialog"
     aria-modal="true">
    <div class="flex min-h-screen items-end justify-center px-4 pb-20 pt-4 text-center sm:block sm:p-0">
        {# Background overlay #}
        <div x-show="isOpen"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="closeModal()"
             class="fixed inset-0 bg-gray-500/75 transition-opacity"
             aria-hidden="true"></div>

        {# Center modal #}
        <span class="hidden sm:inline-block sm:h-screen sm:align-middle" aria-hidden="true">&#8203;</span>

        {# Modal panel #}
        <div x-show="isOpen"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             class="relative inline-block transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6 sm:align-middle">

            {# Loading state #}
            <div x-show="isLoading" class="flex justify-center py-8">
                <svg class="animate-spin h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            {# Form #}
            <form x-show="!isLoading" @submit.prevent="saveTask()">
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900" id="edit-modal-title">Edit Task</h3>
                    </div>

                    {# Error message #}
                    <div x-show="errorMessage" x-cloak class="rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                            </svg>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-red-800" x-text="errorMessage"></p>
                            </div>
                        </div>
                    </div>

                    {# Title #}
                    <div>
                        <label for="edit-title" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text"
                               id="edit-title"
                               x-model="form.title"
                               required
                               class="mt-1 block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    </div>

                    {# Description #}
                    <div>
                        <label for="edit-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="edit-description"
                                  x-model="form.description"
                                  rows="3"
                                  class="mt-1 block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea>
                    </div>

                    {# Status and Priority row #}
                    <div class="grid grid-cols-2 gap-4">
                        {# Status #}
                        <div>
                            <label for="edit-status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="edit-status"
                                    x-model="form.status"
                                    class="mt-1 block w-full rounded-md border-0 py-2 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                <option value="pending">Pending</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>

                        {# Priority #}
                        <div>
                            <label for="edit-priority" class="block text-sm font-medium text-gray-700">Priority</label>
                            <select id="edit-priority"
                                    x-model="form.priority"
                                    class="mt-1 block w-full rounded-md border-0 py-2 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                <option value="1">1 Star</option>
                                <option value="2">2 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="5">5 Stars</option>
                            </select>
                        </div>
                    </div>

                    {# Due Date #}
                    <div>
                        <label for="edit-due-date" class="block text-sm font-medium text-gray-700">Due Date</label>
                        <input type="date"
                               id="edit-due-date"
                               x-model="form.dueDate"
                               class="mt-1 block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                    </div>
                </div>

                {# Actions #}
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button"
                            @click="closeModal()"
                            class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            :disabled="isSaving"
                            class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50">
                        <span x-show="!isSaving">Save Changes</span>
                        <span x-show="isSaving" class="inline-flex items-center gap-2">
                            <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                            Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function taskEditModal() {
    return {
        isOpen: false,
        isLoading: false,
        isSaving: false,
        errorMessage: '',
        taskId: null,
        form: {
            title: '',
            description: '',
            status: 'pending',
            priority: 3,
            dueDate: ''
        },

        async openModal(taskId) {
            this.taskId = taskId;
            this.isOpen = true;
            this.isLoading = true;
            this.errorMessage = '';

            try {
                // Fetch task data
                const response = await fetch(window.apiUrl('/api/v1/tasks/' + taskId), {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to load task');
                }

                const result = await response.json();
                if (result.success && result.data) {
                    const task = result.data;
                    this.form.title = task.title || '';
                    this.form.description = task.description || '';
                    this.form.status = task.status || 'pending';
                    this.form.priority = task.priority || 3;
                    // Parse due date from ISO format to YYYY-MM-DD for date input
                    this.form.dueDate = task.dueDate ? task.dueDate.split('T')[0] : '';
                }
            } catch (error) {
                console.error('Failed to load task:', error);
                this.errorMessage = 'Failed to load task data';
            } finally {
                this.isLoading = false;
            }
        },

        closeModal() {
            this.isOpen = false;
            this.taskId = null;
            this.errorMessage = '';
            this.form = {
                title: '',
                description: '',
                status: 'pending',
                priority: 3,
                dueDate: ''
            };
        },

        async saveTask() {
            if (!this.taskId || !this.form.title.trim()) {
                this.errorMessage = 'Title is required';
                return;
            }

            this.isSaving = true;
            this.errorMessage = '';

            try {
                const payload = {
                    title: this.form.title,
                    description: this.form.description || null,
                    status: this.form.status,
                    priority: parseInt(this.form.priority, 10),
                    dueDate: this.form.dueDate || null
                };

                const response = await fetch(window.apiUrl('/api/v1/tasks/' + this.taskId), {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error?.message || 'Failed to save task');
                }

                if (result.success) {
                    // Show success toast with undo
                    if (result.data?.undoToken && window.showToastWithUndo) {
                        window.showToastWithUndo('Task updated', 'success', result.data.undoToken);
                    } else if (window.showToast) {
                        window.showToast('Task updated', 'success');
                    }

                    this.closeModal();

                    // Reload page to show updated task
                    setTimeout(() => window.location.reload(), 300);
                }
            } catch (error) {
                console.error('Failed to save task:', error);
                this.errorMessage = error.message || 'Failed to save task';
            } finally {
                this.isSaving = false;
            }
        }
    };
}
</script>
