{#
  Project Tree Node - Recursive Component

  Used via Alpine.js template with project object
  Variables:
  - depth: int - Current depth in tree (for indentation)
#}
<div class="project-tree-node"
     :class="{ 'opacity-60 italic': project.isArchived }"
     :data-project-id="project.id"
     :data-depth="{{ depth }}">

    <div class="flex items-center group"
         :class="{
             'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300': selectedProjectId === project.id,
             'hover:bg-gray-50 dark:hover:bg-gray-700': selectedProjectId !== project.id
         }"
         :style="'padding-left: ' + ({{ depth }} * 16 + 8) + 'px'"
         draggable="true"
         @dragstart="handleDragStart($event, project)"
         @dragover="handleDragOver($event, project)"
         @drop="handleDrop($event, project)"
         @dragend="handleDragEnd($event)">

        {# Collapse/Expand Button #}
        <button x-show="project.children && project.children.length > 0"
                @click.stop="toggleCollapse(project.id)"
                class="min-h-11 min-w-11 sm:min-h-0 sm:min-w-0 w-5 h-5 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-transform"
                :class="{ 'rotate-90': !isCollapsed(project.id) }"
                :aria-expanded="!isCollapsed(project.id)"
                :aria-label="isCollapsed(project.id) ? 'Expand ' + project.name : 'Collapse ' + project.name">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>

        {# Spacer when no children #}
        <div x-show="!project.children || project.children.length === 0" class="w-5"></div>

        {# Color Indicator #}
        <div class="w-3 h-3 rounded-full flex-shrink-0 mr-2"
             :style="'background-color: ' + project.color">
        </div>

        {# Project Name - Clickable Link #}
        {# Issue #46: Use window.routes to respect app base path #}
        <a :href="window.routes.taskList + '?projectId=' + project.id"
           class="flex-1 py-2 text-sm truncate"
           :class="{
               'font-medium': selectedProjectId === project.id,
               'text-gray-900 dark:text-gray-100': !project.isArchived,
               'text-gray-500 dark:text-gray-400': project.isArchived
           }"
           x-text="project.name">
        </a>

        {# Task Count Badge #}
        <span x-show="project.taskCount > 0"
              class="px-1.5 py-0.5 text-xs rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 mr-2"
              x-text="project.taskCount">
        </span>

        {# Actions Menu #}
        <div x-data="{ menuOpen: false }" class="relative opacity-0 group-hover:opacity-100 transition-opacity">
            <button @click.stop="menuOpen = !menuOpen"
                    class="min-h-11 min-w-11 sm:min-h-0 sm:min-w-0 p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 rounded flex items-center justify-center"
                    :aria-expanded="menuOpen"
                    :aria-label="'Actions for ' + project.name">
                <span class="sr-only">Project actions</span>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            </button>

            <div x-show="menuOpen"
                 x-cloak
                 @click.away="menuOpen = false"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="transform opacity-0 scale-95"
                 x-transition:enter-end="transform opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="transform opacity-100 scale-100"
                 x-transition:leave-end="transform opacity-0 scale-95"
                 class="absolute right-0 z-10 mt-1 w-40 origin-top-right rounded-md bg-white dark:bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5 dark:ring-gray-700">

                <button @click="$dispatch('open-project-edit-modal', { projectId: project.id }); menuOpen = false"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Edit
                </button>
                <button @click="addSubproject(project.id); menuOpen = false"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Add subproject
                </button>
                <hr class="my-1 border-gray-200 dark:border-gray-700">
                <button x-show="!project.isArchived"
                        @click="archiveProject(project.id); menuOpen = false"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Archive
                </button>
                <button x-show="project.isArchived"
                        @click="unarchiveProject(project.id); menuOpen = false"
                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    Unarchive
                </button>
            </div>
        </div>
    </div>

    {# Children - Recursive rendering with UI depth limit of 10 levels.

       Note on depth limits:
       - Database/Entity allows MAX_HIERARCHY_DEPTH = 50 levels (Project.php)
       - UI renders only 10 levels here to prevent Twig compilation memory issues

       This is intentional: the database constraint ensures data integrity, while the
       lower UI limit is a performance optimization. Projects nested deeper than 10
       levels will still exist and be accessible via direct URLs, but their children
       won't appear in the sidebar tree. This is an acceptable tradeoff since trees
       deeper than 10 levels are rare in practice.

       Decision documented 2026-01-24 during Phase 3 review. #}
    {% if depth < 10 %}
    <div x-show="project.children && project.children.length > 0 && !isCollapsed(project.id)"
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="opacity-0 transform -translate-y-1"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="opacity-100 transform translate-y-0"
         x-transition:leave-end="opacity-0 transform -translate-y-1">
        <template x-for="child in project.children" :key="child.id">
            <div x-data="{ project: child }">
                {% include 'components/project-tree-node.html.twig' with { depth: depth + 1 } %}
            </div>
        </template>
    </div>
    {% endif %}
</div>
