{% extends 'settings/layout.html.twig' %}

{% block settings_title %}Data{% endblock %}

{% block settings_content %}
<div x-data="dataManager()">
    {# Page header #}
    <div class="mb-6">
        <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
            Data Management
        </h1>
        <p class="mt-1 text-sm text-gray-500">
            Export your data or import from other services
        </p>
    </div>

    <div class="space-y-6">
        {# Export section #}
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h2 class="text-base font-semibold text-gray-900">Export Data</h2>
                <p class="mt-1 text-sm text-gray-500">Download a copy of all your data</p>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="space-y-4">
                    <p class="text-sm text-gray-700">
                        Export all your tasks, projects, tags, and settings in JSON format. This file can be used to back up your data or transfer it to another service.
                    </p>
                    <div class="flex flex-wrap gap-3">
                        <button @click="exportData('json')"
                                :disabled="exporting"
                                type="button"
                                class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            <span x-show="!exporting">Export as JSON</span>
                            <span x-show="exporting">Exporting...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {# Import section #}
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h2 class="text-base font-semibold text-gray-900">Import Data</h2>
                <p class="mt-1 text-sm text-gray-500">Import tasks from other services or backup files</p>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="space-y-6">
                    {# Import format selection #}
                    <div>
                        <label for="importFormat" class="block text-sm font-medium text-gray-700">Import format</label>
                        <select
                            id="importFormat"
                            x-model="importFormat"
                            class="mt-1 block w-full rounded-md border-0 py-2 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6"
                        >
                            <option value="json">JSON (Todo-Me backup)</option>
                            <option value="csv">CSV</option>
                            <option value="todoist">Todoist Export</option>
                        </select>
                    </div>

                    {# File upload #}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Upload file</label>
                        <div class="mt-1 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10"
                             :class="{ 'border-indigo-600 bg-indigo-50': isDragging }"
                             @dragover.prevent="isDragging = true"
                             @dragleave.prevent="isDragging = false"
                             @drop.prevent="handleFileDrop($event)">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-300" viewBox="0 0 24 24" fill="currentColor">
                                    <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                                </svg>
                                <div class="mt-4 flex text-sm leading-6 text-gray-600">
                                    <label for="file-upload"
                                           class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500">
                                        <span>Upload a file</span>
                                        <input id="file-upload"
                                               name="file-upload"
                                               type="file"
                                               class="sr-only"
                                               accept=".json,.csv"
                                               @change="handleFileSelect($event)">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs leading-5 text-gray-600">JSON or CSV up to 10MB</p>
                            </div>
                        </div>

                        {# Selected file display #}
                        <div x-show="selectedFile" x-cloak class="mt-4 flex items-center justify-between rounded-md bg-gray-50 px-3 py-2">
                            <div class="flex items-center gap-2">
                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                </svg>
                                <span class="text-sm text-gray-700" x-text="selectedFile?.name"></span>
                                <span class="text-xs text-gray-500" x-text="formatFileSize(selectedFile?.size)"></span>
                            </div>
                            <button @click="selectedFile = null"
                                    type="button"
                                    class="text-gray-400 hover:text-gray-500">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    {# Import button #}
                    <div>
                        <button @click="importData()"
                                :disabled="!selectedFile || importing"
                                type="button"
                                class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="-ml-0.5 mr-1.5 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            <span x-show="!importing">Import Data</span>
                            <span x-show="importing">Importing...</span>
                        </button>
                    </div>

                    {# Import result #}
                    <div x-show="importResult" x-cloak>
                        <div x-show="importResult?.success"
                             class="rounded-md bg-green-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-green-800">Import successful</h3>
                                    <div class="mt-2 text-sm text-green-700" x-text="importResult?.message"></div>
                                </div>
                            </div>
                        </div>
                        <div x-show="!importResult?.success"
                             class="rounded-md bg-red-50 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Import failed</h3>
                                    <div class="mt-2 text-sm text-red-700" x-text="importResult?.message"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Danger zone - Delete account #}
        <div class="bg-white shadow rounded-lg overflow-hidden border border-red-200">
            <div class="px-4 py-5 sm:px-6 border-b border-red-200 bg-red-50">
                <h2 class="text-base font-semibold text-red-900">Danger Zone</h2>
                <p class="mt-1 text-sm text-red-700">Irreversible and destructive actions</p>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-900">Delete Account</h3>
                        <p class="text-sm text-gray-500">Permanently delete your account and all associated data. This action cannot be undone.</p>
                    </div>
                    <button @click="showDeleteModal = true"
                            type="button"
                            class="inline-flex items-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600">
                        Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Delete account modal #}
    <div x-show="showDeleteModal" x-cloak
         class="relative z-50"
         aria-labelledby="delete-modal-title"
         role="dialog"
         aria-modal="true">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     @click.away="showDeleteModal = false">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                            <h3 class="text-base font-semibold leading-6 text-gray-900" id="delete-modal-title">Delete Account</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Are you sure you want to delete your account? All of your data will be permanently removed. This action cannot be undone.
                                </p>
                            </div>
                            <div class="mt-4">
                                <label for="deletePassword" class="block text-sm font-medium text-gray-700">Enter your password to confirm</label>
                                <input type="password"
                                       id="deletePassword"
                                       x-model="deletePassword"
                                       class="mt-1 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-red-600 sm:text-sm sm:leading-6"
                                       placeholder="Your password">
                                <p x-show="deleteError" x-cloak class="mt-2 text-sm text-red-600" x-text="deleteError"></p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                        <button @click="deleteAccount()"
                                :disabled="!deletePassword || deleting"
                                type="button"
                                class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:ml-3 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!deleting">Delete Account</span>
                            <span x-show="deleting">Deleting...</span>
                        </button>
                        <button @click="showDeleteModal = false; deletePassword = ''; deleteError = ''"
                                type="button"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function dataManager() {
    return {
        exporting: false,
        importFormat: 'json',
        selectedFile: null,
        importing: false,
        importResult: null,
        isDragging: false,
        showDeleteModal: false,
        deletePassword: '',
        deleteError: '',
        deleting: false,

        async exportData(format) {
            this.exporting = true;
            try {
                const response = await fetch(window.apiUrl('/api/v1/users/me/export'), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRF-Token': window.getCsrfToken()
                    },
                    credentials: 'same-origin',
                });

                if (response.ok) {
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `todo-me-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export data. Please try again.');
                }
            } catch (error) {
                console.error('Failed to export data:', error);
                alert('Failed to export data. Please try again.');
            } finally {
                this.exporting = false;
            }
        },

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.selectedFile = file;
                this.importResult = null;
            }
        },

        handleFileDrop(event) {
            this.isDragging = false;
            const file = event.dataTransfer.files[0];
            if (file) {
                this.selectedFile = file;
                this.importResult = null;
            }
        },

        formatFileSize(bytes) {
            if (!bytes) return '';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `(${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]})`;
        },

        async importData() {
            if (!this.selectedFile) return;

            this.importing = true;
            this.importResult = null;

            try {
                // Read file content
                const fileContent = await this.readFileContent(this.selectedFile);

                // Determine endpoint and content type based on format
                let endpoint = '/api/v1/import/';
                let contentType = 'application/json';

                switch (this.importFormat) {
                    case 'json':
                        endpoint += 'json';
                        contentType = 'application/json';
                        break;
                    case 'todoist':
                        endpoint += 'todoist';
                        contentType = 'application/json';
                        break;
                    case 'csv':
                        endpoint += 'csv';
                        contentType = 'text/csv';
                        break;
                    default:
                        throw new Error('Unknown import format');
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': contentType,
                        'Accept': 'application/json',
                        'X-CSRF-Token': window.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: fileContent,
                });

                if (response.ok) {
                    const data = await response.json();
                    this.importResult = {
                        success: true,
                        message: data.data?.message || 'Import completed successfully.',
                    };
                    this.selectedFile = null;
                    // Reset the file input
                    const fileInput = document.getElementById('file-upload');
                    if (fileInput) fileInput.value = '';
                } else {
                    const data = await response.json();
                    this.importResult = {
                        success: false,
                        message: data.error?.message || 'Import failed. Please check your file and try again.',
                    };
                }
            } catch (error) {
                console.error('Failed to import data:', error);
                this.importResult = {
                    success: false,
                    message: error.message || 'Import failed. Please try again.',
                };
            } finally {
                this.importing = false;
            }
        },

        readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        },

        async deleteAccount() {
            if (!this.deletePassword) return;

            this.deleting = true;
            this.deleteError = '';

            try {
                const response = await fetch(window.apiUrl('/api/v1/users/me'), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-Token': window.getCsrfToken()
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ password: this.deletePassword }),
                });

                if (response.ok || response.status === 204) {
                    // Redirect to home page after account deletion
                    window.location.href = '/';
                } else {
                    const data = await response.json();
                    this.deleteError = data.error?.message || 'Failed to delete account. Please check your password.';
                }
            } catch (error) {
                console.error('Failed to delete account:', error);
                this.deleteError = 'Failed to delete account. Please try again.';
            } finally {
                this.deleting = false;
            }
        }
    };
}
</script>
{% endblock %}
